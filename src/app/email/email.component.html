<div class="container">
  <div class="email-banner mat-elevation-z4">
    <mat-stepper [linear]="true" #stepper>
      <!-- Step 1: Gmail Configuration -->
      <mat-step [stepControl]="configForm">
        <mat-card class="example-card" appearance="outlined">
          <mat-card-header>
            <mat-card-title
              >Sender Gmail Setup with App Password</mat-card-title
            >
          </mat-card-header>
          <mat-card-content>
            <form [formGroup]="configForm">
              <ng-template matStepLabel>Configure Gmail</ng-template>
              <div class="config-form">
                <mat-form-field appearance="outline" class="full-width">
                  <mat-label>Gmail ID</mat-label>
                  <input
                    matInput
                    placeholder="yourname@gmail.com"
                    formControlName="senderGmail"
                    type="email"
                    required
                  />
                </mat-form-field>

                <mat-form-field appearance="outline" class="full-width">
                  <mat-label>Password</mat-label>
                  <input
                    matInput
                    placeholder="Gmail Password"
                    formControlName="password"
                    type="password"
                    required
                  />
                </mat-form-field>
              </div>
              <div class="information">
                <p>Please follow these instructions</p>
                <ul>
                  <li>
                    <strong>Gmail ID</strong> is your personal Gmail address.
                  </li>
                  <li>
                    <strong>Password</strong> is your 16-digit Gmail
                    <strong>App Password</strong>.
                  </li>
                  <li>
                    Use a
                    <a
                      href="https://myaccount.google.com/apppasswords"
                      target="_blank"
                      rel="noopener"
                    >
                      Google App Password </a
                    >, not your regular Gmail password.
                  </li>
                  <li>
                    You may need to enable
                    <a
                      href="https://myaccount.google.com/security"
                      target="_blank"
                      rel="noopener"
                    >
                      2-Step Verification
                    </a>
                    first.
                  </li>
                  <li>
                    To create an App Password, visit
                    <a
                      href="https://myaccount.google.com/apppasswords"
                      target="_blank"
                      rel="noopener"
                    >
                      Google App Passwords
                    </a>
                    and follow the instructions.
                  </li>
                </ul>
              </div>
            </form>
          </mat-card-content>
          <mat-card-footer class="example-card-footer">
            <div></div>
            <button mat-button matStepperNext [disabled]="configForm.invalid">
              Next
            </button>
          </mat-card-footer>
        </mat-card>
      </mat-step>

      <!-- Step 2: Email Form -->
      <mat-step [stepControl]="emailForm">
        <ng-template matStepLabel>Send Emails</ng-template>
        <mat-card class="example-card" appearance="outlined">
          <mat-card-header>
            <mat-card-title>Send Personalized Emails</mat-card-title>
          </mat-card-header>
          <mat-card-content>
            <form [formGroup]="emailForm" class="email-form">
              <mat-form-field class="full-width" appearance="outline">
                <mat-label>Subject</mat-label>
                <input
                  matInput
                  formControlName="subject"
                  placeholder="Subject"
                />
              </mat-form-field>

              <mat-form-field class="full-width" appearance="outline">
                <mat-label>Email Body</mat-label>
                <textarea
                  matInput
                  [rows]="10"
                  formControlName="body"
                  placeholder="Email Body"
                ></textarea>
              </mat-form-field>

              <div formArrayName="companies" class="company-wrapper">
                <div class="button-row">
                  @if (companies.controls.length > 1) {
                  <button
                    mat-button
                    type="button"
                    (click)="removeConfirm()"
                    title="Remove last one"
                    [ngClass]="{'remove-indicate': isRemove}"
                  >
                    <span>{{isRemove ? 'Remove X' : 'Remove'}}</span>
                  </button>
                  } @if (companies.valid || companies.controls.length > 1) {
                  <div @fadeInOut>
                    <button
                      mat-raised-button
                      color="accent"
                      type="button"
                      [ngClass]="{ btnDisable: companies.invalid }"
                      (click)="addCompany()"
                      title="Add more companies"
                      class="mb-1-rem"
                    >
                      Add Companies
                    </button>
                  </div>
                  }
                </div>
                <div
                  *ngFor="let group of companies.controls; let i = index"
                  [formGroupName]="i"
                  class="company-group"
                >
                  <mat-form-field class="full-width" appearance="outline">
                    <mat-label>Company Name</mat-label>
                    <input
                      matInput
                      formControlName="company"
                      placeholder="Company Name"
                    />
                  </mat-form-field>

                  <mat-form-field class="full-width" appearance="outline">
                    <mat-label>Recipient Email</mat-label>
                    <input
                      matInput
                      formControlName="email"
                      placeholder="Email Address"
                      type="email"
                    />
                  </mat-form-field>
                  @if (isRemove && companies.controls.length > 1) {
                  <div @fadeInOut class="delete-row-wrapper" (click)="removeCompany(i)" (keydown)="removeCompany(i)">
                    Remove row <mat-icon>delete</mat-icon>
                  </div>
                  }
                </div>
              </div>
              <div class="file-upload" #bottomOfForm>
                <label for="fileInput" class="upload-label">
                  ðŸ“Ž Attachment:
                </label>
                <div class="row">
                  <label for="fileInput" class="custom-file-input">
                    <span>Choose File</span>
                    <input
                      id="fileInput"
                      type="file"
                      (change)="onFileChange($event)"
                      title="Choose a file to attach"
                    />
                  </label>

                  <!-- Show selected file name -->
                  <div class="file-name" *ngIf="selectedFile?.name">
                    ðŸ“„ {{ selectedFile?.name }}
                  </div>
                </div>
              </div>
            </form>
          </mat-card-content>
          <mat-card-footer class="example-card-footer">
            <div></div>
            <div class="button-row">
              <button mat-button matStepperPrevious title="Previous step">
                Back
              </button>
              <button
                title="send"
                mat-raised-button
                color="accent"
                class="button-fixed sendBtn"
                [ngClass]="{ btnDisable: emailForm.invalid }"
              >
                <div
                  class="send"
                  type="submit"
                  (click)="submitForm()"
                  (keydown)="submitForm()"
                >
                  Send
                </div>
                <div class="open-options" [matMenuTriggerFor]="sendOption">
                  <mat-icon class="send-icon">arrow_drop_down</mat-icon>
                </div>
              </button>
            </div>
          </mat-card-footer>
        </mat-card>
      </mat-step>
    </mat-stepper>
  </div>

  @if (isLoading) {
  <app-loader [loaderMessage]="loaderMessage"></app-loader>
  }
</div>

<mat-menu #sendOption="matMenu" yPosition="above">
  <button mat-menu-item (click)="scheduleMail()">
    <mat-icon class="mr-5">schedule</mat-icon>Schedule mail
  </button>
</mat-menu>
