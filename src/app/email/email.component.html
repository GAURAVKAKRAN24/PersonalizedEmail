<div class="container">
  <div class="email-banner mat-elevation-z4">
    <mat-stepper [linear]="true" #stepper>
      <!-- Step 1: Gmail Configuration -->
      <mat-step [stepControl]="configForm">
        <mat-card class="example-card" appearance="outlined">
          <mat-card-header>
            <mat-card-title>Gmail Setup with App Password</mat-card-title>
          </mat-card-header>
          <mat-card-content>
            <form [formGroup]="configForm">
              <ng-template matStepLabel>Configure Gmail</ng-template>
              <div class="config-form">
                <mat-form-field appearance="outline" class="full-width">
                  <mat-label>Gmail ID</mat-label>
                  <input
                    matInput
                    placeholder="yourname@gmail.com"
                    formControlName="senderGmail"
                    type="email"
                    required
                  />
                </mat-form-field>

                <mat-form-field appearance="outline" class="full-width">
                  <mat-label>Password</mat-label>
                  <input
                    matInput
                    placeholder="Gmail Password"
                    formControlName="password"
                    type="password"
                    required
                  />
                </mat-form-field>
              </div>
              <div class="information">
                <h4>Please follow these instructions</h4>
                <ul>
                  <li>
                    <strong>Gmail ID</strong> is your personal Gmail address.
                  </li>
                  <li>
                    <strong>Password</strong> is your 16-digit Gmail App
                    Password.
                  </li>
                  <li>
                    To create an App Password, visit
                    <a
                      href="https://myaccount.google.com/apppasswords"
                      target="_blank"
                      rel="noopener noreferrer"
                    >
                      Google App Passwords
                    </a>
                    and follow the instructions.
                  </li>
                </ul>
              </div>
            </form>
          </mat-card-content>
          <mat-card-footer class="example-card-footer">
            <div>
              <button mat-button matStepperNext [disabled]="configForm.invalid">
                Next
              </button>
            </div>
          </mat-card-footer>
        </mat-card>
      </mat-step>

      <!-- Step 2: Your Existing Email Form (unchanged) -->
      <mat-step [stepControl]="emailForm">
        <ng-template matStepLabel>Send Emails</ng-template>
        <mat-card class="example-card" appearance="outlined">
          <mat-card-header>
            <mat-card-title>Send Personalized Emails</mat-card-title>
          </mat-card-header>
          <mat-card-content>
            <form [formGroup]="emailForm" class="email-form">
              <mat-form-field class="full-width" appearance="outline">
                <mat-label>Subject</mat-label>
                <input
                  matInput
                  formControlName="subject"
                  placeholder="Subject"
                />
              </mat-form-field>

              <mat-form-field class="full-width" appearance="outline">
                <mat-label>Email Body</mat-label>
                <textarea
                  matInput
                  [rows]="8"
                  formControlName="body"
                  placeholder="Email Body"
                ></textarea>
              </mat-form-field>

              <div formArrayName="companies" class="company-wrapper">
                <div
                  *ngFor="let group of companies.controls; let i = index"
                  [formGroupName]="i"
                  class="company-group"
                >
                  <mat-form-field class="full-width" appearance="outline">
                    <mat-label>Company Name</mat-label>
                    <input
                      matInput
                      formControlName="company"
                      placeholder="Company Name"
                    />
                  </mat-form-field>

                  <mat-form-field class="full-width" appearance="outline">
                    <mat-label>Email Address</mat-label>
                    <input
                      matInput
                      formControlName="email"
                      placeholder="Email Address"
                      type="email"
                    />
                  </mat-form-field>
                </div>
              </div>

              <div dir="rtl">
                <div class="button-row">
                  <button
                    mat-raised-button
                    color="accent"
                    type="button"
                    [ngClass]="{ btnDisable: companies.invalid }"
                    (click)="addCompany()"
                  >
                    Add More
                  </button>
                  @if (companies.controls.length > 1) {
                  <button
                    mat-raised-button
                    color="accent"
                    type="button"
                    (click)="removeCompany()"
                  >
                    Remove
                  </button>
                  }
                </div>
              </div>

              <div class="file-upload">
                <label for="fileInput">Attachment:</label>
                <input
                  id="fileInput"
                  type="file"
                  (change)="onFileChange($event)"
                  title="Choose a file to attach"
                />
              </div>
            </form>
          </mat-card-content>
          <mat-card-footer class="example-card-footer">
            <button
              mat-raised-button
              color="accent"
              class="button-fixed"
              type="submit"
              [ngClass]="{ btnDisable: emailForm.invalid }"
              (click)="submitForm()"
            >
              <mat-icon fontIcon="send"></mat-icon>
              Send
            </button>
            <button mat-button matStepperPrevious>Back</button>
          </mat-card-footer>
        </mat-card>
      </mat-step>
    </mat-stepper>
  </div>

  @if (isLoading) {
  <div class="loader">
     {{loaderMessage}}<span class="dots">
      <span>.</span><span>.</span><span>.</span>
    </span>
  </div>
  }
</div>
